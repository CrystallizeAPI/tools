on:
    push:
        tags:
            - '*'

name: Release a New Version

jobs:
    releaseandpublish:
        name: Release on Github
        runs-on: ubuntu-latest
        steps:
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: false

            - name: ‚éî Setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: üì• Download deps
              working-directory: components/cli
              run: bun install --frozen-lockfile

            - name: üî® Compiling the different versions
              working-directory: components/cli
              run: make build-all

            - name: üè∑ Create GitHub Release
              run: |
                  TAG_MESSAGE=$(gh api repos/${{ github.repository }}/git/tags/${GITHUB_SHA} --jq '.message' || git log -1 --pretty=format:%B $GITHUB_SHA)
                  TAG_NAME=$(gh api repos/${{ github.repository }}/git/tags/${GITHUB_SHA} --jq '.tag')
                  gh release create "${TAG_NAME}" --title "Release ${TAG_NAME}" --notes "${TAG_MESSAGE}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: üöÄ Upload Assets
              run: |
                  ASSET_PLATFORMS=("bun-linux-x64 bun-linux-arm64 bun-windows-x64 bun-darwin-x64 bun-darwin-arm64")
                  for platform in "${ASSET_PLATFORMS[@]}"; do
                    if [ -f "crystallize-$platform" ]; then
                      gh release upload "${GITHUB_REF_NAME} ($platform)" "crystallize-$platform" --clobber
                      echo "Uploaded file for platform $platform"
                    else
                      echo "File for platform $platform not found, skipping."
                    fi
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
